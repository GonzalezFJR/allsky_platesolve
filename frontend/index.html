<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calibración All-Sky</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="app-header">
      <div>
        <h1>Calibración de Cámara All-Sky</h1>
        <p class="subtitle">Sube una imagen, configura tu observación y empieza a identificar estrellas para ajustar el modelo.</p>
      </div>
      <div class="header-actions">
        <button id="downloadParams" class="primary" disabled>Descargar parámetros</button>
      </div>
    </header>

    <main class="layout">
      <section class="panel viewer">
        <div id="dropZone" class="drop-zone">
          <input type="file" id="fileInput" accept="image/*" hidden />
          <div class="drop-message">
            <strong>Arrastra y suelta</strong> tu imagen all-sky aquí o
            <button id="browseButton" type="button">explorar</button>
          </div>
          <canvas id="skyCanvas" width="800" height="800" aria-label="Imagen all-sky"></canvas>
          <div id="noImageOverlay" class="overlay-message">Sube una imagen para comenzar</div>
        </div>
        <div class="viewer-controls">
          <label><input type="checkbox" id="toggleDetections" checked /> Mostrar detecciones</label>
          <label><input type="checkbox" id="toggleExpected" checked /> Mostrar posiciones esperadas</label>
          <label><input type="checkbox" id="toggleLabels" checked /> Mostrar nombres</label>
          <label><input type="checkbox" id="toggleIdentified" checked /> Mostrar identificadas</label>
        </div>
        <div class="star-display-controls">
          <div class="control-group">
            <label>Tamaño de etiquetas
              <input type="range" id="labelSize" min="8" max="24" step="1" value="14" />
              <span id="labelSizeValue">14px</span>
            </label>
          </div>
          <div class="control-group">
            <label>Máximo de estrellas
              <input type="number" id="maxStars" min="10" max="500" step="10" value="100" />
            </label>
          </div>
          <div class="control-group">
            <label><input type="checkbox" id="sortByMagnitude" checked /> Ordenar por magnitud</label>
          </div>
        </div>
        <div class="viewer-info" id="viewerInfo"></div>
      </section>

      <section class="panel controls">

        <div class="controls-grid">
          <div class="card">
            <h2>Datos de la captura</h2>
            <form id="observationForm" class="form-grid">
              <label>Latitud
                <input type="number" step="any" id="latitude" required placeholder="Ej. 41.387" />
              </label>
              <label>Longitud
                <input type="number" step="any" id="longitude" required placeholder="Ej. 2.168" />
              </label>
              <label>Altitud (m)
                <input type="number" step="1" id="elevation" value="0" />
              </label>
              <label>Fecha y hora (UTC)
                <input type="datetime-local" id="captureTime" required />
              </label>
              <label>Modelo radial
                <select id="modelType"></select>
              </label>
              <label class="checkbox-inline">
                <input type="checkbox" id="isNadir" checked /> Imagen en vista nadir
              </label>
              <button type="submit" class="primary">Actualizar proyección</button>
            </form>
          </div>

          <div class="card">
            <h2>Detección de estrellas</h2>
            <form id="detectionForm" class="form-grid">
              <label>FWHM (px)
                <input type="number" step="0.1" id="fwhm" name="fwhm" value="4" min="1" />
              </label>
              <label>Threshold (σ)
                <input type="number" step="0.1" id="threshold" name="threshold" value="5" min="0.5" />
              </label>
              <label>SharpLo
                <input type="number" step="0.1" id="sharplo" name="sharplo" value="0.2" />
              </label>
              <label>SharpHi
                <input type="number" step="0.1" id="sharphi" name="sharphi" value="1.0" />
              </label>
              <label>RoundLo
                <input type="number" step="0.1" id="roundlo" name="roundlo" value="-1.0" />
              </label>
              <label>RoundHi
                <input type="number" step="0.1" id="roundhi" name="roundhi" value="1.0" />
              </label>
              <label>Nº máximo
                <input type="number" step="1" id="limit" name="limit" value="50" min="1" />
              </label>
              <div class="button-row">
                <button type="submit" class="secondary">Detectar estrellas</button>
                <button id="resetDetections" type="button">Limpiar</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h2>Identificación de estrellas</h2>
            <div id="matchingPanel">
              <p>Haz clic en una detección (círculo blanco) para seleccionarla y asigna una estrella del catálogo.</p>
              <div class="match-form">
                <label>Estrella detectada
                  <input type="text" id="selectedDetection" disabled placeholder="Ninguna" />
                </label>
                <label>Nombre en catálogo
                  <input list="starNames" id="starNameInput" placeholder="Ej. Vega" />
                  <datalist id="starNames"></datalist>
                </label>
                <div class="button-row">
                  <button id="confirmMatch" type="button" class="primary" disabled>Identificar estrella</button>
                  <button id="clearMatches" type="button">Resetear identificaciones</button>
                </div>
              </div>
              <div class="matches-list">
                <h3>Estrellas identificadas</h3>
                <ul id="matchesList"></ul>
              </div>
            </div>
          </div>

          <div class="card span-2" id="modelSummary">
            <h2>Parámetros del modelo</h2>
            <div class="parameter-editor">
              <div class="parameter-group">
                <h3>Centro de la imagen (xc, yc)</h3>
                <div class="parameter-row">
                  <label>Xc
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="xcMin" placeholder="Min" step="1">
                      <input type="range" class="parameter-slider" id="xcSlider" min="1470" max="1570" step="1" value="1520">
                      <input type="number" class="limit-input" id="xcMax" placeholder="Max" step="1">
                      <span class="slider-value" id="xcValue">1520</span>
                    </div>
                  </label>
                </div>
                <div class="parameter-row">
                  <label>Yc
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="ycMin" placeholder="Min" step="1">
                      <input type="range" class="parameter-slider" id="ycSlider" min="1470" max="1570" step="1" value="1520">
                      <input type="number" class="limit-input" id="ycMax" placeholder="Max" step="1">
                      <span class="slider-value" id="ycValue">1520</span>
                    </div>
                  </label>
                </div>
              </div>

              <div class="parameter-group">
                <h3>Rotación del sensor (°)</h3>
                <div class="parameter-row">
                  <label>Theta
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="thetaMin" placeholder="Min" step="0.1">
                      <input type="range" class="parameter-slider" id="thetaSlider" min="-180" max="180" step="0.1" value="0">
                      <input type="number" class="limit-input" id="thetaMax" placeholder="Max" step="0.1">
                      <span class="slider-value" id="thetaValue">0.0</span>
                    </div>
                  </label>
                </div>
              </div>

              <div class="parameter-group">
                <h3>Inclinación de la cámara</h3>
                <div class="parameter-row">
                  <label>Ángulo de inclinación (°)
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="tiltAngleMin" placeholder="Min" step="0.1">
                      <input type="range" class="parameter-slider" id="tiltAngleSlider" min="0" max="10" step="0.1" value="0">
                      <input type="number" class="limit-input" id="tiltAngleMax" placeholder="Max" step="0.1">
                      <span class="slider-value" id="tiltAngleValue">0.0</span>
                    </div>
                  </label>
                </div>
                <div class="parameter-row">
                  <label>Azimut de inclinación (°)
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="tiltAzimuthMin" placeholder="Min" step="0.1">
                      <input type="range" class="parameter-slider" id="tiltAzimuthSlider" min="0" max="360" step="0.1" value="0">
                      <input type="number" class="limit-input" id="tiltAzimuthMax" placeholder="Max" step="0.1">
                      <span class="slider-value" id="tiltAzimuthValue">0.0</span>
                    </div>
                  </label>
                </div>
              </div>

              <div class="parameter-group">
                <h3>Coeficientes radiales</h3>
                <div class="parameter-row">
                  <label>Coeficiente A
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="coeffAMin" placeholder="Min" step="0.001">
                      <input type="range" class="parameter-slider" id="coeffASlider" min="0.01" max="3" step="0.001" value="0.2">
                      <input type="number" class="limit-input" id="coeffAMax" placeholder="Max" step="0.001">
                      <span class="slider-value" id="coeffAValue">0.200</span>
                    </div>
                  </label>
                </div>
                <div class="parameter-row">
                  <label>Coeficiente B
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="coeffBMin" placeholder="Min" step="0.001">
                      <input type="range" class="parameter-slider" id="coeffBSlider" min="0.1" max="2" step="0.001" value="0.8">
                      <input type="number" class="limit-input" id="coeffBMax" placeholder="Max" step="0.001">
                      <span class="slider-value" id="coeffBValue">0.800</span>
                    </div>
                  </label>
                </div>
                <div class="parameter-row" id="coeffCRow">
                  <label>Coeficiente C
                    <div class="slider-container">
                      <input type="number" class="limit-input" id="coeffCMin" placeholder="Min" step="0.001">
                      <input type="range" class="parameter-slider" id="coeffCSlider" min="0.5" max="2" step="0.001" value="1.0">
                      <input type="number" class="limit-input" id="coeffCMax" placeholder="Max" step="0.001">
                      <span class="slider-value" id="coeffCValue">1.000</span>
                    </div>
                  </label>
                </div>
              </div>

              <div class="parameter-actions">
                <button id="updateParameters" class="primary">Actualizar proyección</button>
                <button id="refitParameters" class="primary">Reajustar</button>
                <button id="resetParameters" class="secondary">Restaurar valores</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div id="toast" role="status" aria-live="polite"></div>

    <script src="/static/app.js" type="module"></script>
  </body>
</html>
